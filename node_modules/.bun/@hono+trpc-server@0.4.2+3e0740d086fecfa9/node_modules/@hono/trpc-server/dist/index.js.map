{"version":3,"file":"index.js","names":[],"sources":["../src/index.ts"],"sourcesContent":["import type { AnyRouter } from '@trpc/server'\nimport type {\n  FetchCreateContextFnOptions,\n  FetchHandlerRequestOptions,\n} from '@trpc/server/adapters/fetch'\nimport { fetchRequestHandler } from '@trpc/server/adapters/fetch'\nimport type { Context, MiddlewareHandler } from 'hono'\nimport { routePath } from 'hono/route'\n\ntype tRPCOptions = Omit<\n  FetchHandlerRequestOptions<AnyRouter>,\n  'req' | 'endpoint' | 'createContext'\n> &\n  Partial<Pick<FetchHandlerRequestOptions<AnyRouter>, 'endpoint'>> & {\n    createContext?(\n      opts: FetchCreateContextFnOptions,\n      c: Context\n    ): Record<string, unknown> | Promise<Record<string, unknown>>\n  }\n\nexport const trpcServer = ({\n  endpoint,\n  createContext,\n  ...rest\n}: tRPCOptions): MiddlewareHandler => {\n  const bodyProps = new Set(['arrayBuffer', 'blob', 'formData', 'json', 'text'] as const)\n  type BodyProp = typeof bodyProps extends Set<infer T> ? T : never\n  return async (c) => {\n    const canWithBody = c.req.method === 'GET' || c.req.method === 'HEAD'\n\n    // Auto-detect endpoint from route path if not explicitly provided\n    let resolvedEndpoint = endpoint\n    if (!endpoint) {\n      const path = routePath(c)\n      if (path) {\n        // Remove wildcard suffix (e.g., \"/v1/*\" -> \"/v1\")\n        resolvedEndpoint = path.replace(/\\/\\*+$/, '') || '/trpc'\n      } else {\n        resolvedEndpoint = '/trpc'\n      }\n    }\n\n    const res = await fetchRequestHandler({\n      ...rest,\n      createContext: async (opts) => ({\n        ...(createContext ? await createContext(opts, c) : {}),\n        // propagate env by default\n        env: c.env,\n      }),\n      endpoint: resolvedEndpoint!,\n      req: canWithBody\n        ? c.req.raw\n        : new Proxy(c.req.raw, {\n            get(t, p, _r) {\n              if (bodyProps.has(p as BodyProp)) {\n                return () => c.req[p as BodyProp]()\n              }\n              return Reflect.get(t, p, t)\n            },\n          }),\n    })\n    return res\n  }\n}\n"],"mappings":";;;;AAoBA,MAAa,cAAc,EACzB,UACA,cACA,GAAG,WACiC;CACpC,MAAM,YAAY,IAAI,IAAI;EAAC;EAAe;EAAQ;EAAY;EAAQ;EAAO,CAAU;AAEvF,QAAO,OAAO,MAAM;EAClB,MAAM,cAAc,EAAE,IAAI,WAAW,SAAS,EAAE,IAAI,WAAW;EAG/D,IAAI,mBAAmB;AACvB,MAAI,CAAC,UAAU;GACb,MAAM,OAAO,UAAU,EAAE;AACzB,OAAI,KAEF,oBAAmB,KAAK,QAAQ,UAAU,GAAG,IAAI;OAEjD,oBAAmB;;AAuBvB,SAnBY,MAAM,oBAAoB;GACpC,GAAG;GACH,eAAe,OAAO,UAAU;IAC9B,GAAI,gBAAgB,MAAM,cAAc,MAAM,EAAE,GAAG,EAAE;IAErD,KAAK,EAAE;IACR;GACD,UAAU;GACV,KAAK,cACD,EAAE,IAAI,MACN,IAAI,MAAM,EAAE,IAAI,KAAK,EACnB,IAAI,GAAG,GAAG,IAAI;AACZ,QAAI,UAAU,IAAI,EAAc,CAC9B,cAAa,EAAE,IAAI,IAAgB;AAErC,WAAO,QAAQ,IAAI,GAAG,GAAG,EAAE;MAE9B,CAAC;GACP,CAAC"}